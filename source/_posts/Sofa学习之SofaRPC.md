---
title: Sofa学习之SofaRPC
date: 2018-08-10 17:42:05
tags: SofaRPC
---
1.Sofa是蚂蚁自主研发的金融级分布式中间件，包含构建金融级云原生架构所需的各个组件，包括微服务研发框架，RPC框架，服务注册中心，分布式定时任务，限流/熔断框架，动态配置推送，分布式链路追踪，Metrics监控度量，分布式高可用消息队列，分布式事务框架，分布式数据库代理层等组件，是一套分布式架构的完整解决方案。

	- SofaRPC是蚂蚁金服开源高可扩展，高性能，生产级的JavaRPC框架。
	- SOfaRPC致力于简化应用之间的RPC调用，为应用提供方便透明，稳定高效的点对点远程服务调用方案。SofaRPC提供丰富的模型抽象和可扩展接口，包括过滤器，路由，负载均衡等等。
	- SofaRPC功能特性:
		- (1)透明化，高性能的远程服务调用；
		- (2)支持多种服务器路由以及负载均衡策略；
		- (3)支持多种注册中心的集成；
		-（4）支持多种协议；
		-（5）支持同步单向回调泛化等多种调用方式；
		-（6）支持集群容错，服务预热，自动故障隔离；
		-（7）强大的扩展功能，按需扩展。
2. 架构设计
	1. 从上到下分为两层：
		-  核心层：包含RPC的核心组件以及一些通用的实现，如随机等负载均衡算法；
		-  功能实现层：所有功能实现层的用户都是平等的，都是基于扩展机制实现的。
	2. 架构原理
		1. Client
		    Client 			----->客户端发起调用--->调用Stub
			Proxy  			----->生成Stub,拦截调用，保存调用请求相关信息--->路由寻址
			Router&Registry ----->根据参数信息从Router和连接管理器中取地址--->参数序列化，作为二进制准备传递
			Codec           ----->添加requestId等，按照协议格式编码之后传递--->数据编码--->网络传输--->DeCondec:按照协议的规范，进行节码--->解码,序列化--->
			ServerWorkerManager--->管理发布的服务Bean,进行反射调用--->
			Server --->业务处理
		2. Sofa源码主要包括
			1. all(发布打包模块)，
			2. bom(依赖管控模块，用于依赖版本管控)，
			3. example(示例模块)，
			4. test(测试模块，集成测试)，
			5. core(
				1. api:API模块，涵盖各种基本流程接口,消息,上下文,扩展接口等;
				2. common公共模块，
				3. 涵盖工具类utils,数据结构;
				4. exception:异常模块，涵盖各种异常接口等)。
			6. core模块包括
				1. bootstrap,启动实现模块，用于启动类，发布或者引用服务逻辑,以及registry的操作；
				2. proxy代理实现模块，用于接口实现代理生成；
				3. client 客户端实现模块，用于发送请求，接收响应，连接维护，路由，负载均衡，同步异步等；
				4. server 服务端实现模块，用于启动监听，接收请求，发送响应，业务线程分发等；
				5. filter 拦截器实现模块，用于服务端和客户端的各种拦截器实现；
				6. codec 编解码实现模块，例如压缩，序列化等；
				7. protocol 协议实现模块，用于协议的包装处理，协商；
				8. transport 网络传输实现模块，用于Tcp连接，数据分包粘包处理，请求响应对象分发等；
				9. registry 注册中心实现模块，实现注册中心，如zk等。

		3. 实现原理
			1. Sofa rpc远程调用时通过服务模型来定义调用双方的，服务分为服务消费方和服务提供方，对应rpc的调用端和被调用端。service和reference;
			2. 当Sofa rpc的应用启动的时候，如果发现当前应用需求需要发布RPC服务的话，那么sofa rpc会将这些服务注册到配置中心上；
			3. 当引用这个服务的sofa应用启动时，会从配置中心订阅对应服务的地址；
			4. 当配置中心收到订阅请求后，会将发布方的地址列表推送给订阅方；
			5. 当引用服务的一方拿到地址以后，就可以发起直连调用服务。
		

			
			
	