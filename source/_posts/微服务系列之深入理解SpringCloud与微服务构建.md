---
title: 微服务系列之深入理解SpringCloud与微服务构建
date: 2018-08-29 16:25:35
tags: SpringCloud 微服务
---

### 序 ###
1. 系统的架构决定了系统能否满足业务，技术，组织，灵活，可扩展性等多种要求，同时肩负起了解放程序员生产力的作用。
2. 微服务框架:服务注册和发现===Eureka组件，负载均衡Ribbon组件，熔断器Hystrix组件，路由网关Zuul组件，SpringCloud配置中心，服务链路追踪等内容。
3. 微服务提出者Martin Fowler

<!-- more -->

## 第2章 SpringCloud简介 ##
### 2.1 微服务应该具备的功能 ###
1. 服务:一个独立运行的单元组件，每个单元组件运行在独立的进程中，组件与组件之间通常使用HTTP的通信机制进行通信。
2. 微服务的特点:
	1. 按照业务来划分服务，单个服务代码量小，业务单一，易于维护；
	2. 每个微服务都有自己独立的基础组件，如数据库，缓存，且运行在独立的进程中；
	3. 微服务之间的通信通过Http协议或者消息组件，且具有容错能力；
	4. 微服务有一套服务治理的解决方案，服务之间不耦合，可以随时加入和剔除服务；
	5. 单个微服务能够集群化部署，并且负载均衡能力；
	6. 整个微服务系统有一个完整的安全机制，包括用户验证，权限验证，资源保护等；
	7. 链路追踪的能力；
	8. 完整的实时日志系统。
### 2.1.1 服务的注册与发现 ###
- 服务粒度小，服务数量众多，服务之间相互依赖成网状，需要服务注册中心来同一管理微服务实例，方便查看每一个微服务实例的健康状态。
- 服务注册是指向服务注册中心注册一个服务实例，服务提供者将自己的服务信息(如服务名，IP地址等)告知服务注册中心。
- 服务发现是指当服务消费者需要消费另一个服务时，服务注册中心能够告知服务消费者它所要消费服务的实例信息（服务名，IP地址等）。
- 通常一个服务既是服务提供者也是服务消费者，使用Http协议或者消息组件进行服务费。
- 注册中心会提供服务的健康检查方案，检查被注册的服务是否可用。通常实例注册后，会定时向服务注册中心提供心跳，以表明自己还处于可用状态。当一个服务实例停止向服务注册中心提供心跳一段时间后，服务注册中心会认为该服务实例不可用，将会从服务注册列表中剔除。
- 如果这个被剔除掉的服务实例过一段时间重新加入服务器注册中心列表中，就重新恢复心跳。
- 微服务的服务注册组件都回提供服务的健康状况查看UI界面，通过界面可以指导服务的健康状态。
### 2.1.2 服务的负载均衡 ###
- 微服务架构中，服务之间相互调用通过http通信协议来实现。网络往往不可靠，为了保证高可用，服务单元往往需要集群化部署。===>引发负载均衡
- 服务消费者集成了负载均衡组件，该组件回向服务消费者提供获取的服务注册列表，并隔一段时间重新刷新该列表。
- 注册中心集群化。
#### 2.1.3 集群的容错 ####
- 部分服务不可用，引发阻塞，消耗系统资源，引发雪崩。
- 解决方案：熔断机制
	1. 当一个服务处理用户请求失败次数小于设定的阈值时，熔断器处于关闭状态，服务正常
	2. 当失败次数大于设定阈值时，说明服务出现了故障，打开熔断器，所有该服务的请求会执行快速失败，不执行业务逻辑。
	3. 当处于打开状态的熔断器时，一段时间后会处于半打开状态，并执行一定数量的请求，剩余的请求会执行快速失败，如果执行请求失败，则继续打开熔断器；若成功了，则将熔断器关闭。 
- 熔断器的附加功能：
	1. 将资源隔离，如果某个API出现故障，将该API隔离，不会影响其他API接口。被隔离的API接口会执行快速失败的逻辑，不会等待，请求不会阻塞。
	2. 服务降级功能。当服务处于正常状态时，大量请求在短时间内同时涌入，超过了服务的处理能力，这是熔断器打开可以将服务降级，以免服务器因负载过高而出现故障。
	3. 自我修复能力。比如网络短时间内不可用，熔断器被打开。如果不能自我监控，自我检测和自我修复，那么需要开发人员手动去关闭熔断器，会增加开发工作量。
	4. Netfix的Hystrix熔断器组件功能非常强大，有熔断器功能，熔断器状态检测，UI，开发人员或者运维人员通过UI界面能够直观看到熔断器的状态和各种性能指标。
#### 2.1.4 服务网关 ####	
	1. 微服务系统通过将资源以API接口的形式暴露给外界来提供服务。API接口资源通常是由服务网关统一暴露，内部服务不直接对外提供API资源暴露，将内部服务隐藏。
	2. API网关通常有请求转发的作用，可能需要负责一定的安全验证，如请求是否合法，对某一资源是否具有操作权限等。
	3. 通常网关层以集群形式存在，在服务网关层之前，会加上负载均衡层，通常为nginx双机热备，通过一定路由策略，将请求转发到网管层。
	4. 到达网关层后，经过一系列用户身份验证，权限判断，最终转发到具体的服务。
	5. 服务经过一些列的逻辑运算和数据操作，最终将结果返回给用户。
	6. 网关层的意义：
		1. 网关将所有的API接口资源统一聚合，对外统一暴露，外界系统调用的API接口都是网关对外暴露的API接口。
		2. 身份认证，权限认证，防止非法请求操作API接口，对内部服务起保护作用。
		3. 网关可以实现监控功能，实时日志输出，对请求进行记录。
		4. 网关可以用来做流控，在流量情况下，对服务进行降级。
		5. API接口从内部服务分离出来，方便测试。
#### 2.1.5 服务配置的统一管理 ####
	1. 数据库配置，日志是输出级别配置，不同环境不一样，管理复杂。
	2. SpringCloud的Config组件，阿里Diamond，百度Disconf，携程Apollo等。
	3. 大致过程：
		1. Config Server读取配置文件仓库的配置信息，其中配置文件存放在配置服务的本地仓库，也可以放在远程Git仓库。
		2. 配置服务启动后，读取配置文件信息，读取完成配置信息存放在配置服务的内存中。
		3. 当启动服务A,B是，由于服务A，B指定了向配置服务读取配置信息，服务A，B向配置服务读取配置信息。
		4. 当服务配置信息需要修改且修改完成后，向配置服务发送Post请求进行刷新，这时服务A,B会向配置服务重写读取配置文件。
#### 2.1.6 服务链路追踪 ####
	1. 服务单元数量多且复杂，服务与服务之间的调用非常复杂，出现异常和错误很难追踪；
	2. 实现分布式链路追踪，去跟进一个请求到底有哪些服务参与，参与的顺序，使得每个请求链路清晰可见，方便问题定位。
### 2.2 Sprin Cloud ###
	1. 基于SpringBoot--->简化开发和部署的过程，简化Spring复杂的配置和依赖管理；
	2. 通过起步依赖和内置Servlet容器就能快速搭建起一个Web工程。 
	3. SpringCloud首要目标是通过一些列开发组件和框架，快速搭建分布式微服务系统。
#### 2.2.1 常用组件 ####
### 2.3 Dubbo ###
	1. RPC调用:封装了长连接NIO框架，采用多线程模式；
	2. 集群容错：提供了基于接口方法的远程调用功能。集群容错:实现了负载均衡，失败容错；服务发现:集成了Zookeeper,用于服务注册和发现。
	3. SpringCloud通信方式基于http restful风格，服务与服务之间五耦合，无状态，语言平台普适。
	4. Dubbo基于远程调用，对接口平台和语言有强依赖。跨平台调用更需要额外依赖。 
### 2.4 Kubernetes简介 ###
	1.Kubernetes是一个容器集群管理系统，为容器化的应用程序提供部署运行，维护，扩展，资源调度，服务发现等功能呢。

## 3.构建微服务的准备 ##
### 3.3 构建啊工具Maven使用 ###
	1. 基于工程对象模型，Maven可以管理项目构建整个生命周期，包括清理，编译，打包，测试等环节。
	2. 构建一个项目需要的流程：
		1. 生成源码； 2. 从源码中生存文档；3.编译源码；4.测试；5.将源码打包成Jar,运行在服务器，仓库或者其他位置。
#### 3.3.1 Maven核心概念 ####
	1. 核心是pom文件，pom文件以及xml文件的形式表示的资源，依赖jar,插件，构建文件等。
	2. 工作过程：
		1. Maven 读取pom文件，构建的生命周期各阶段和目标；
		2. 依赖--->Maven本地仓库；
		3. 构建插件
		4. 构建Profile
	3. 首先读取pom文件，pom文件时Maven核心，所有的项目依赖，插件都在pom文件中统一管理。
	4. 下载依赖jar到本地仓库。Maven命令执行时，首先会检查pom文件的依赖jar，当检测本地没有安装jar时，会默认Maven的中央仓库下载依赖Jar，中央仓库地址为:/.
	5. 依赖下载后，会存放在本地仓库中，如果下载不成功，该命令无法执行通过。
	6. 执行构建的生命周期。Maven的构建过程会被分解成构建阶段和构建目标，共同构成了Maven的生命周期。
	7. 执行构建插件。插件可以更方便地执行构建各个阶段，可以用插件实现一些额外功能。
#### 3.3.2 编写Pom文件 ####
	1. pom文件是一个xml文件，用于描述项目用到的资源，项目依赖，插件，代码位置等信息。
	2. pom.xml文件一般放在根目录。
#### 3.3.3 Maven构建项目的生命周期 ####
	1. Maven工程中，默认定义了构建工程的生命周期，本身集成了这些插件。
	2. validate initialize compile test package verify install deploy
#### 3.3.4 常用Maven命令 ####
	1. mvn clean 删除工程target下所有文件；
	2. mvn package将工程打为jar包
	3. 上述由一些列命令构成：
		1. 验证verify
		2. 编译compile
		3. 处理代码
		4. 生成资源文件
		5. 生成Jar包
		6. 测试
	4. mvn package -Dmaven.test.ship=ture，打包跳过测试；
	5. mvn compile 编译代码工程，不生成jar包；
	6. mvn install 包含了mvn package的所有过程，并且将生成的jar包安装到本地仓库。
	7. mvn spring-boot:run 使用spring-boot插件，启动Springboot工程；
	8. mvn test 测试；
	9. mvn idea:idea 生成idea项目
	10. mvn mvnLjar只打jar包
	11. mvn vaildate 检验资源是否可用。

## 4.Spring Boot ##
	1. 特点：自动配置，起步依赖，Actuator对运行状态的监控。
	2. 安全，度量，监控检查，内嵌Servlet容器，外置设置
### 4.1 构建SpringBoot项目 ###	
	1. @SpringBootApplication注解包含了@SpringBootConfiguration,@EnableAutoConfiguration和@	ComponentScan，开启包扫描配置和自动配置的功能；
	2. @RestController = @Controller + @ResponseBody；
	3. @RequestMapping = 配置请求地址的Url映射； 
	4. 测试:
		1. @RunWith(SpringRunner.class) 和 SpringBootTest注解。
		2. @SpringBootTest注解加上Web测试环境的端口为随机端口的配置 
### 4.2 SpringBoot 配置文件详解 ###
#### 4.2.1 自定义属性 ####
	1. 默认创建application.properties;同时也支持yml格式的文件；
	2. 读取配置文件的值:在变量上加上@Value("${属性名}")；
#### 4.2.2 将配置文件的属性赋给实体类 ####
	1. 当有多个配置属性的时候，通常会把这些属性名创建一个JavaBean变量，并将属性值赋给JavaBean变量。
	2. random.int 生成整型值，random.uuid生成一个uuid,random.value随机生成一个值，random.value(10)随机生成一个小于10整数。
	3. 在一个Bean类上加一个注解@ConfigurationProperies,表明该类为配置属性类，并且加上配置的prefix,并且加上@Component注解。
#### 4.2.3 自定义配置文件 ####
	1. 如在resource下自定义一个test.properties配置文件：
		com.my.name = rocky
		com.my.age = 23
	2. 此时需要在类名上加上@Configuration,@PropertySource和@ConfigurationProperties这3个注解。
### 4.3 运行状态监控Actuator ###
### 4.4 SpringBoot 整合JPA ###
### 4.5 SpringBoot 整合Redis ###
	1. Redis简介
	2. 加入redis依赖
## 5.服务注册与发现Eureka ##
### 5.1 源码解析Eureka ###
	1. Register---服务注册
		当Eureka Client向Euerka Server注册时，Eureka Client提供自身的元数据，如IP地址，端口，运行状态指标Url,主页地址信息
	2. Renew---服务续约
		Eureka Client每隔30秒发送一次心跳来进行服务续约。通过服务续约来告知Eureka Server该Eureka Client仍然可用，没有出现故障。正常情况下，如果Eureka Server在90s内没有收到Eureka Client的心跳，EurekaServer会将Eureka Client实例从注册列表中删除。
	3. Fetch Registries---获取服务注册列表信息
		C从S获取服务注册表信息，并将其缓存在本地。C使用服务注册列表信息查找其他服务信息，从而进行RPC。该注册列表信息定时更新，每次返回与缓存可能不同，Eureka Client缓存信息不同，C会自己处理。注册信息不匹配时，C重新获取整个注册表信息。S缓存了所有服务的注册列表信息，并将整个注册列表以及每个应用程序的信息进行压缩，以Json和XML数据格式进行通信。默认使用Json方式来获取服务注册列表信息。

	4. Cancel---服务下线
		C程序关闭时，向S发送下线请求。完成请求后，S将C从list删除。需要在程序关闭时调用方法。
	5. Eviction---服务剔除
		连续90s没有向Eureka Server发送服务续约，就会将该S从服务注册列表删除。
### 5.2.1 Eureka高可用架构 ###
### 5.2.2 Register服务注册 ###
### 5.2.3 Renew服务续约 ###

## 6. 负载均衡Ribbon ##
### 6.1 RestTemplate简介 ###
	1. 是SpringResources中的一个访问第三方Restful API接口的网络请求框架。目的都是为了执行复杂任务提供一个具有默认行为的简单方法。
	2. RestTemplate是用来消费Rest服务的，所有方法都与Rest的Http协议的一些方法紧密相连。
### 6.2 Ribbon简介 ###
	1. 负载均衡方式:独立进程单元，通过负载均衡策略将请求转发到不同执行单元上，如Nginx；另一种是将负载均衡逻辑以代码形式封装到服务消费者的客户端上，C中维护了一份服务提供者信息列表，通过负载均衡策略将请求分摊给多个服务提供者，从而达到负载均衡的目的。
	2. Ribbon采用第二种方式。有两种使用方式：一种是和RestTemplate结合，另一种是和Feign结合。默认与feign结合。
	3. 源码解析
## 7.声明式调用Feign ##
## 8.熔断器Hystrix ##
1. 分布式系统中，服务与服务之间的依赖错综复杂，一种不可避免的情况就是某些服务出现故障，导致依赖他们的其他服务出现远程调度的线程阻塞。Hystrix具有熔断器功能，能够阻止分布式系统中出现联动故障。Hystrix通过隔离服务访问点阻止联动故障，并提供故障解决方案，从而提高整个分布式系统的弹性。
2. 高并发情况下，单个服务的延迟会导致整个请求都处于延迟状态，导致服务处于线程饱和状态，资源消耗殆尽。并且因为服务的依赖，导致其他服务也处于阻塞状态，引发雪崩。
3. Hystrix设计原则	
	1. 防止单个服务的故障耗尽整个服务的Serlvet容器线程资源。
	2. 快速失败机制，如果单个服务出现故障，则调用服务的请求快速失败，而不是线程等待。
	3. 提供回退方案，在请求发生故障时，提供设定好的回退方案。
	4. 使用熔断机制，防止故障扩散到其他服务。
	5. 提供熔断器监控组件Hystrix Dashboard,实时监控熔断器状态。
4. Hystrix工作机制

## 9.路由网关Spring Cloud Zuul ##
1. 用于构建边界服务，致力于动态路由，过滤，监控，弹性伸缩和安全。
### 9.1 为什么需要Zuul ###
### 9.2 Zuul工作原理 ###
