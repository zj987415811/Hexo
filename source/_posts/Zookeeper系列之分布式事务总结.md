---
title: Zookeeper系列之分布式事务总结
date: 2018-08-09 11:44:54
tags: Zookeeper
---
##1.分布式事务解决方案##
- 基于XA协议的两阶段提交方案
	- 第一阶段：表决阶段，所有参与者将本事务能否成功的信息反馈发送给协调者；
	- 第二阶段是执行阶段，协调者根据所有参与者的反馈，通知所有参与者，一致地在所有分支上提交或者回滚。
	- 本地资源管理器 事务协调器
	- 借助数据库的XA协议协调数据库资源，借助数据库的MVCC特性达到一致性读写。

- TCC方案
	- 将整个业务逻辑的每个分支显示的分成了Try,Confirm,Cancel三个操作。
	- Try部分完成业务的准备工作，Confirm部分完成业务的提交，Cancel部分完成事务的回滚。
	- 事务开始时，业务应用会向事务协调器注册启动事务。之后业务应用会调用所有服务的try接口，完成一阶段准备。之后事务协调器会根据try接口返回情况，决定调用confirm接口或者cancel接口。如果接口调用失败会进行重试。 
	- 优点：应用自己定义数据库操作的粒度，使得降低锁冲突，提升吞吐量。
	- 缺点：
		- 对应用的侵入性强。业务逻辑的每个分支都需要实现try,confirm,cancel。入侵大
		- 实现难度大。需要按照网络状态，系统故障等不同的失败原因实现不同的回滚策略。为了满足一致性要求，confirm和cancel接口必须实现幂等。
- 基于消息的最终一致性方案
	- 消息一致性方案是通过消息中间件保证上下游应用数据操作的一致性。
	- 基本思路: 将本地操作和发送消息放在一个事务中，保证本地操作和消息发送要么两者都成功或者都失败。下游应用向消息系统订阅该消息，收到后执行相应操作。
	- 本质：将分布式事务转换为两个本地事务，依靠下游业务得重试机制达到最终一致性。
- FMT:无入侵得分布式事务解决方案，该模式下只需要关注一阶段操作，框架会自动解析SQL语义生成二阶段提交和回滚操作，使分布式事务得接入更便捷。
- 蚂蚁金服的分布式事务解决方案DTX
	- 整体架构：
		- 以Base理论的最终一致性为基础，以两阶段提交为基本执行框架。整体架构上分为3部分：客户端，资源管理器，事务管理器
		- 客户端：通过事务管理器来开启结束分布式事务，通过资源管理器编排分布式事务活动。
		- 资源管理器：负责具体资源的准备，提交和回滚操作，并在整个执行过程中记录事务日志，向事务管理器汇报事务日志和资源执行状态。
		- 事务协调器：负责协调分布式事务的执行:开启分布式事务，记录资源管理器提交的事务日志和资源状态，决定分布式事务最终使提交还是回滚。
	- DTX执行
		- DTX按照两阶段提交的方式执行分布式事务，在第一阶段，客户端首先通过事务管理器开启分布式事务；分布式事务开启后，客户端在分布式事务内编排事务内资源，依次执行各个资源的一阶段准备操作，每个资源的准备操作执行情况资源管理器都会向事务管理器汇报，资源编排结束之后，客户端会通知事务管理器分布式事务一阶段结束。
		- 在第二阶段，事务管理器会根据事务所有资源的一阶段执行情况，决定整个分布式事务最终是提交还是回滚，进而驱动所有资源二阶段的提交/回滚。 
	